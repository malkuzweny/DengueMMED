---
title: "Modelling Dengue Fever in Sri-Lanka to inform Study Design"
author: Brian

format: html

editor: visual
filters:
  - authors-block/authors-block.lua
bibliography: dengue_study_design.bib

csl: Extras/clinical-mass-spectrometry.csl

toc: true
---

```{r, setup}
#| echo: false
source("dengue_working.R")
source("samplesizeCalc.R")

```

## Introduction/Background

Dengue causes 400 million infections worldwide every year, leading to 100 million becoming ill and 21,000 deaths (making it the most impactful arboviral disease in humans).
Case incidence increased rapidly from 0.5 million in 2000 to 5 million in 2019.
https://www.who.int/news-room/fact-sheets/detail/dengue-and-severe-dengue
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3651993/
https://www.cdc.gov/dengue/training/cme/ccm/page51440.html
Four serotypes
Second infection most severe
Since early 2000s dengue outbreaks in Sri Lanka have become larger and multiple serotypes are now circulating [FOI Sri Lanka paper 2013]
Vector control is main focus of prevention efforts

## Research questions 


## Objectives

1.  Know S4 in Colombo for age ranges (find the Lambda in Colombo)

2.  Get disease data for Colombo and Gampaha

3.  Link lambda with disease in Colombo (find Rho)

4.  Using the Rho from Colombo, find the number of, passive surveillance cases, acive surveillance cases and Infections (through seroprevalence. Find Lambda with disease in Gampaha with the Rho of Colombo

5.  Calculate the number of participants needed in a cluster randomised trial.  

## Methods


```{r}
#| label: fig-salde
#| fig-cap: "SLADE model diagram. Note: Time steps nor all compartments are displayed."
knitr::include_graphics("Blank diagram.png")
```

### Deriving lambda and initial conditions for Colombo

We take the probability of first infection of \~ 14.1%.[@tam2013EstimatesDengueForce],

$$
P(First\;Infection|No\;Infection) = 1 - (1 - \lambda)^{4}= 0.141\
\\\
\\
therefore \; \lambda = 0.037
$$

We ran the simulation for 100 years, as the burn-in period. We determined the proportion of each susceptibility status per age.

## Obtaining disease data for Colombo and Gampaha

Annual reported cases averaged over 5 years per 10 000 population is 100/10 000 pop. in Colombo and 77/10 000 pop in Gampaha. (ref)

## Calculate Rho

$$
\rho = P(case|I2)  = case detection proportion/ I2
$$

## Determine Lambda in Gampaha

We estimated the relationship between force of infection and reported cases in Colombo, assuming all reported cases are due to secondary infections. We also assumed the force of infection to case relationship is the same in both areas.



### Case definitions

We assume 100% Sensitivity and specificity in all diagnostics.

**Passive surveillance case** - Symptomatic infections that presents to a health facility in Gampaha in year x.

$$
PassiveCase  = I2*P(case|I2)
$$

**Infection Surveillance** - Any positive identified by Dengue IgG or IgM in Gampaha in year x.

$$
InfectionCase = I2
$$

## Assumptions

We assume age distribution in Gampaha and Colombo are the same.

## Power Calculations

### Equations
$$
n= (Z_\frac{\alpha}{2} \quad + \quad Z_\beta) ^2 \frac{\pi_0(1-\pi_0) + \pi_A(1-\pi_A)}{(\pi_0 - \pi_A)^2 }
$$

$$
\text{assuming} \; n \; \text{individuals per cluster, the necessary number of clusters is calculated:} 
$$

$$
c = 1 + (Z_\frac{\alpha}{2} \quad + \quad Z_\beta) ^2 \frac{\frac{\pi_0(1-\pi_0)}{n}+ \frac{ \pi_A(1-\pi_A)}{n} + k^2 (\pi_0^2 + \pi_A^2) }{(\pi_0 - \pi_A)^2 }
$$

## Results
### 
```{r}
#| label: fig-lambdacalc
#| fig-cap: "DIagram of the proportion of estimated to Colombo with varying Force of infection. We assume Colombo has a lambda of 0.037 ( derived from Primary infection incidence) and that Gampaha has 77% of the cases in Colombo. We also assume that cases are secondary infections." 
#| echo: false

{
plot(x = I2_vec/I2_vec[38], y = lambda_vals, type = "l", 
     xlab = "Modelled cases proportional to Colombo" , 
     ylab = "Force of Infection")
abline(v = 1.0)
abline(h = lambda_vals[38])
abline(v = 0.77)
#value of lambda where I2_vec/I2_vec[38] is closest to 38
abline(h = lambda_vals[15])
}
```
### Model output
```{r}
#| label: fig-modeloutput
#| fig-cap: "Output"
#| echo: false

source("createPlots.R")

```

```{r}
#| label: fig-sampsi
#| fig-cap: "The sample sizes needed to show \_pi sample size for k clusters and n participants."
#| echo: false



{
 cl.perarm.case_k1_e1 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[1], k = k_vec[1], 
                                     nr.percluster = 20:200)
  cl.perarm.case_k2_e1 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[1], k = k_vec[2], 
                                     nr.percluster = 20:200)
  cl.perarm.case_k3_e1 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[1], k = k_vec[3], 
                                     nr.percluster = 20:200)
  
  dev.new(width=12, height=5, noRStudioGD = TRUE, units = "in")
  
  layout(matrix(1:3, ncol=3, byrow=T))
  par(oma=c(0,0,2,0))
  
  plot(x=20:200, y=cl.perarm.case_k1_e1, type="l", col="black", 
       xlab="Number of children\nper cluster", ylab="Number of clusters per arm", 
       main="Effect size: 0.25",
       log="y")
  lines(x=20:200, y=cl.perarm.case_k2_e1, col="red")
  lines(x=20:200, y=cl.perarm.case_k3_e1, col="green")
  
  cl.perarm.case_k1_e2 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[2], k = k_vec[1], 
                                     nr.percluster = 20:200)
  cl.perarm.case_k2_e2 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[2], k = k_vec[2], 
                                     nr.percluster = 20:200)
  cl.perarm.case_k3_e2 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[2], k = k_vec[3], 
                                     nr.percluster = 20:200)
  
  plot(x=20:200, y=cl.perarm.case_k1_e2, type="l", col="black", 
       xlab="Number of children\nper cluster", ylab="Number of clusters per arm",
       main="Effect size: 0.3",
       log="y")
  lines(x=20:200, y=cl.perarm.case_k2_e2, col="red")
  lines(x=20:200, y=cl.perarm.case_k3_e2, col="green")
  
  cl.perarm.case_k1_e3 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[3], k = k_vec[1], 
                                     nr.percluster = 20:200)
  cl.perarm.case_k2_e3 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[3], k = k_vec[2], 
                                     nr.percluster = 20:200)
  cl.perarm.case_k3_e3 <- run.sscalc(z_a2=1.96, z_b=0.84, pi_0=0.015, 
                                     treatment_effect = effectsizes[3], k = k_vec[3], 
                                     nr.percluster = 20:200)
  
  plot(x=20:200, y=cl.perarm.case_k1_e3, type="l", col="black", 
       xlab="Number of children\nper cluster", ylab="Number of clusters per arm",
       main="Effect size: 0.35",
       log="y")
  lines(x=20:200, y=cl.perarm.case_k2_e3, col="red")
  lines(x=20:200, y=cl.perarm.case_k3_e3, col="green")
  legend("topright", legend=c("k=0.02", 
                              "k=0.15",
                              "k=0.25"), col=c("black", "red", "green"), lty=1)
  
  mtext("Subject enrollment using cases as events", line=0, side=3, outer=TRUE, cex=1.2)
  
  
}
```

```{r}


plot_sample_infections()

```

We present the samples size on the x axis and clusters on the y axis for varying effect size $\pi_{diff}$ and inter-cluster coefficient $k$.


## Next Steps
